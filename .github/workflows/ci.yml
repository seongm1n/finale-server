name: CI

on:
  pull_request:
    branches:
      - dev
      - main
  push:
    branches:
      - dev

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests with Gradle
        run: ./gradlew test --no-daemon --stacktrace
        env:
          # H2 in-memory database for testing
          SPRING_DATASOURCE_URL: "jdbc:h2:mem:testdb"
          SPRING_DATASOURCE_DRIVER_CLASS_NAME: "org.h2.Driver"
          SPRING_DATASOURCE_USERNAME: "sa"
          SPRING_DATASOURCE_PASSWORD: ""
          SPRING_JPA_HIBERNATE_DDL_AUTO: "create-drop"
          SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: "org.hibernate.dialect.H2Dialect"
          # JWT configuration
          JWT_SECRET: "test-secret-key-for-jwt-token-signing-minimum-256-bits-required-for-hs256-algorithm"
          JWT_ACCESS_TOKEN_EXPIRATION: "3600000"
          JWT_REFRESH_TOKEN_EXPIRATION: "604800000"
          # OAuth2 configuration
          GOOGLE_ANDROID_CLIENT_ID: "test-google-android-client-id"
          GOOGLE_IOS_CLIENT_ID: "test-google-ios-client-id"
          GOOGLE_WEB_CLIENT_ID: "test-google-web-client-id"
          KAKAO_CLIENT_ID: "test-kakao-client-id"
          APPLE_CLIENT_ID: "test-apple-client-id"
          APPLE_TEAM_ID: "test-apple-team-id"
          APPLE_KEY_ID: "test-apple-key-id"
          # OpenAI API
          OPENAI_API_KEY: "test-api-key"

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/build/test-results/test/*.xml
          check_name: Test Results

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: build/reports/tests/test/
          retention-days: 7
